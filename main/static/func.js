var timer;powerAVGchartData=0,hourEnergyData=0;var refreshGraphs=0;function update_ints_count(){$.ajax({url:"/updateData"}).done(function(e){$("#updateData").html(e.datalayer);var t=e.U1,n=e.U2,a=e.U3;document.getElementById("U").textContent=t+"/"+n+"/"+a;var r=((e.I1>32767?e.I1-65535:e.I1)/1e3).toFixed(1),o=((e.I2>32767?e.I2-65535:e.I2)/1e3).toFixed(1),s=((e.I3>32767?e.I3-65535:e.I3)/1e3).toFixed(1);document.getElementById("I").textContent=r+"/"+o+"/"+s,document.getElementById("Total_Energy").textContent=((e.E1_P+e.E2_P+e.E3_P)/1e3).toFixed(2),document.getElementById("Previous_Energy").textContent=e.Emin_Positive,document.getElementById("Current_Energy").textContent=e.Emin_Positive,powerAVGchartData=e.P_minuten,hourEnergyData=e.E_hour;var i=(e.P1>32767?e.P1-65535:e.P1)+(e.P2>32767?e.P2-65535:e.P2)+(e.P3>32767?e.P3-65535:e.P3);document.getElementById("Power").textContent=i+" W",document.getElementById("ACTUAL_CONFIG_CURRENT").textContent=e.ACTUAL_CONFIG_CURRENT,document.getElementById("ACTUAL_OUTPUT_CURRENT").textContent=e.ACTUAL_OUTPUT_CURRENT,document.getElementById("EV_STATE").textContent=e.EV_STATE,1==hourEnergyData[1]&&refreshEnergyChart(),document.getElementById("time").textContent=getTime(),timer=setTimeout(update_ints_count,1e3)})}function stop(){timer&&(console.log("stopTimer"),clearTimeout(timer),timer=0)}function getTime(){var e=new Date;return e.getHours()+" : "+e.getMinutes()+" : "+e.getSeconds()}function loadPowerChart(){len=powerAVGchartData[0];for(var e=1;e<61-len;e++)powerGraph.config.data.datasets.forEach(function(t){t.data.push({x:Date.now()-1e3*(61-e)*60,y:0})});for(e=1;e<len;e++){var t=0;t=null!=powerAVGchartData[e]?powerAVGchartData[e]:0,powerGraph.config.data.datasets.forEach(function(n){n.data.push({x:Date.now()-1e3*(len-e)*60,y:t})})}powerGraph.update()}function refreshPowerChart(){len=powerAVGchartData[0],powerGraph.config.data.datasets.forEach(function(e){e.data.push({x:Date.now(),y:powerAVGchartData[len-1]})})}function refreshEnergyChart(){len=hourEnergyData[0],console.log("Delka:"+len),console.log("Data:"+hourEnergyData);for(var e=0,t=0,n=0;n<(len-2)/2;n++)null!=hourEnergyData[2*n+2]&&(t=hourEnergyData[2*n+2],e=hourEnergyData[2*n+3],energyGraph.data.labels[n]=t,energyGraph.data.datasets[0].data[n]=e,energyGraph.update())}$(document).ready(function(){$("div.mainContainer").load("datatable",function(){$(".loading").hide();let e=new energyChart,t=new powerChart(refreshPowerChart),n=document.getElementById("powerGraph").getContext("2d"),a=t.getConfig();powerGraph=new Chart(n,a);let r=document.getElementById("energyGraph").getContext("2d"),o=e.getConfig();energyGraph=new Chart(r,o),update_ints_count(),setTimeout(function(){loadPowerChart()},2e3)}),$(".menu a").click(function(e){"main"==$(this).attr("id")?(stop(timer),$("div.mainContainer").load("datatable",function(){let e=new powerChart(refreshPowerChart),t=document.getElementById("powerGraph").getContext("2d"),n=e.getConfig();powerGraph=new Chart(t,n);let a=new energyChart,r=document.getElementById("energyGraph").getContext("2d"),o=a.getConfig();energyGraph=new Chart(r,o),update_ints_count(),setTimeout(function(){loadPowerChart()},1e3)})):"settings"==$(this).attr("id")&&(stop(timer),$("div.mainContainer").load("settings",function(){$("#refreshSSID").append('<span class="spinner-border spinner-border-sm"></span>'),setting=new Setting,setting.refreshSetting(),setTimeout(function(){setting.refreshWifiClient()},500),powerGraph.destroy(),energyGraph.destroy()})),$(".menu a").removeClass("active"),$(this).addClass("active")}),$(document).on("click","#setSSID",function(){$("#setSSID").append('<span class="spinner-border spinner-border-sm"></span>'),password=document.getElementById("passwordField").value;var e=$("input[name='ssid']:checked").val();return e?(alert("I will try to connect wifi with ssid: "+e),$.ajax({type:"POST",url:"/updateWificlient",async:!0,data:JSON.stringify({ssid:e,password:password}),success:function(e){$("#updateWificlient").html(e.datalayer),1==e.process?alert("Process was success, Your new IP address is: "+e.ip):alert("Process was unsuccess")}}).success(function(){$(this).parent("span").remove()})):alert("Please choose ssid client first!"),0}),$(document).on("click","#readReg",function(){return register=document.getElementById("modbusReg").value,document.getElementById("modbusIO").value="waiting ...",register>0?$.ajax({type:"POST",url:"/readRegister",async:!0,data:JSON.stringify({register:register}),success:function(e){$("#readRegister").html(e.datalayer),$(this).parent("span").remove(),document.getElementById("modbusIO").value=e.data}}):(alert("Please choose register betwean 1-10000"),$(this).parent("span").remove()),0}),$(document).on("click","#refreshSSID",function(){$("div.mainContainer").load("settings",function(){$("#refreshSSID").append('<span class="spinner-border spinner-border-sm"></span>'),setting.refreshWifiClient(),setting.refreshSetting()})})});